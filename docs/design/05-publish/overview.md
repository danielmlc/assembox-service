# 发布流程设计

> **状态**: 设计中
> **更新日期**: 2025-01-24

---

## 目录

1. [概述](#1-概述)
2. [架构设计](#2-架构设计)
3. [发布流程](#3-发布流程)
4. [产品与版本管理](#4-产品与版本管理)
5. [环境策略](#5-环境策略)
6. [回滚机制](#6-回滚机制)
7. [设计决策记录与相关文档](#7-设计决策记录与相关文档)

---

## 1. 概述

### 1.1 架构转型

Assembox 采用 **"代码生成 + 构建发布"** 模式，而非传统低代码平台的"运行时解释"模式。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        架构对比                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  传统模式（运行时解释）                                                       │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐                  │
│  │ 用户请求 │ ──▶│ 读取配置 │ ──▶│ 解析元数据│ ──▶│ 动态执行 │                  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘                  │
│                       ↑                                                     │
│               每次请求都要解析，性能瓶颈                                       │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Assembox（代码生成 + 构建发布）                                              │
│                                                                             │
│  设计时                          发布时                       运行时          │
│  ┌─────────┐                   ┌─────────┐                 ┌─────────┐     │
│  │ 配置元数据│                   │ 生成代码 │                 │ 编译产物 │     │
│  └────┬────┘                   └────┬────┘                 └────┬────┘     │
│       │                             │                           │          │
│       ▼                             ▼                           ▼          │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │  设计器  │ ──▶│  发布   │ ──▶│构建编译 │ ──▶│  部署   │ ──▶│直接执行 │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│                                                                   ↑        │
│                                             无解析开销，性能最优 ────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心优势

| 维度 | 运行时解释 | 代码生成 |
|-----|----------|---------|
| **性能** | 每次请求解析元数据，有运行时开销 | 编译后直接执行，无额外开销 |
| **调试** | 黑盒执行，难以排查问题 | 生成标准代码，可断点调试 |
| **扩展** | 需要深入理解引擎机制 | 生成代码后可直接二次开发 |
| **AI友好** | 动态逻辑难以被 AI 理解 | 生成的代码可直接喂给 AI 分析 |
| **可维护性** | 引擎升级影响所有应用 | 生成的代码版本固定，互不影响 |
| **类型安全** | 运行时才能发现类型错误 | 编译时即可发现类型错误 |

### 1.3 生成范围

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        代码生成范围                                          │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────┐
                    │      元数据配置      │
                    │  (JSON in OSS)      │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │     代码生成器       │
                    │  (Code Generator)   │
                    └──────────┬──────────┘
                               │
         ┌─────────────────────┼─────────────────────┐
         │                     │                     │
         ▼                     ▼                     ▼
┌────────────────┐   ┌────────────────┐   ┌────────────────┐
│   后端代码      │   │   前端代码      │   │   配置文件      │
│                │   │                │   │                │
│ *.entity.ts    │   │ *.vue          │   │ package.json   │
│ *.dto.ts       │   │ *.ts           │   │ tsconfig.json  │
│ *.controller.ts│   │ router.ts      │   │ Dockerfile     │
│ *.service.ts   │   │ api.ts         │   │ docker-compose │
│ *.module.ts    │   │                │   │                │
└────────────────┘   └────────────────┘   └────────────────┘
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │    完整项目源码      │
                    │   (Git Repository)  │
                    └─────────────────────┘
```

### 1.4 关键设计原则

1. **元数据是唯一真实来源 (Single Source of Truth)**
   - 生成的代码是"编译产物"，不允许手动修改
   - 所有定制通过插件/配置实现，而非修改生成代码

2. **产品级发布**
   - 同一产品下的所有模块打包为一个服务
   - 一次发布，前后端同步部署

3. **环境隔离**
   - 预览环境：使用运行时引擎快速预览（秒级生效）
   - 生产环境：使用生成代码部署（性能最优）

4. **版本可追溯**
   - 每次发布生成的代码提交到 Git
   - 可查看任意版本的实际运行代码

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        发布系统架构                                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           设计器 (Designer)                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  页面设计    │  │  模型设计    │  │  API设计    │  │  逻辑设计    │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│         └────────────────┼────────────────┼────────────────┘                │
│                          ▼                ▼                                 │
│                    ┌─────────────────────────┐                              │
│                    │   保存/发布 按钮         │                              │
│                    └───────────┬─────────────┘                              │
└────────────────────────────────┼────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         发布服务 (Publish Service)                           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      PublishOrchestrator                             │   │
│  │                        发布编排器                                     │   │
│  └────────────────────────────────┬────────────────────────────────────┘   │
│                                   │                                         │
│         ┌─────────────────────────┼─────────────────────────┐              │
│         │                         │                         │              │
│         ▼                         ▼                         ▼              │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐        │
│  │ 版本管理器   │          │ 代码生成器   │          │ 构建触发器   │        │
│  │VersionMgr  │          │CodeGenerator│          │BuildTrigger │        │
│  └──────┬──────┘          └──────┬──────┘          └──────┬──────┘        │
│         │                        │                        │                │
└─────────┼────────────────────────┼────────────────────────┼────────────────┘
          │                        │                        │
          ▼                        ▼                        ▼
   ┌─────────────┐          ┌─────────────┐          ┌─────────────┐
   │   TiDB      │          │   Gitea     │          │  Jenkins    │
   │  版本记录    │          │  源码仓库    │          │  CI/CD      │
   └─────────────┘          └─────────────┘          └──────┬──────┘
                                                           │
                            ┌──────────────────────────────┘
                            │
                            ▼
                     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
                     │   Build     │ ──▶ │   Push      │ ──▶ │   Deploy    │
                     │  Docker镜像 │     │  Registry   │     │  K8s/Docker │
                     └─────────────┘     └─────────────┘     └─────────────┘
```

### 2.2 核心服务组件

| 组件 | 职责 | 输入 | 输出 |
|-----|------|------|------|
| **PublishOrchestrator** | 编排整个发布流程 | 发布请求 | 发布结果 |
| **VersionManager** | 管理发布版本 | 产品/版本信息 | 版本快照 |
| **CodeGenerator** | 生成源代码 | 元数据配置 | 源代码文件 |
| **BuildTrigger** | 触发 CI/CD | 源码仓库地址 | 构建任务 |
| **DeploymentManager** | 管理部署状态 | 构建产物 | 部署结果 |

### 2.3 数据流向

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        发布数据流                                            │
└─────────────────────────────────────────────────────────────────────────────┘

1. 元数据读取
   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
   │   TiDB      │ ──────▶ │ 元数据快照   │ ──────▶ │   OSS       │
   │ 配置索引    │         │   生成      │         │ JSON内容    │
   └─────────────┘         └─────────────┘         └─────────────┘

2. 代码生成
   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
   │  元数据      │ ──────▶ │ 代码生成器   │ ──────▶ │ 源代码文件   │
   │  JSON       │         │ Generator   │         │ .ts/.vue    │
   └─────────────┘         └─────────────┘         └─────────────┘

3. 源码提交
   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
   │ 源代码文件   │ ──────▶ │  Git Push   │ ──────▶ │   Gitea     │
   │             │         │             │         │  仓库       │
   └─────────────┘         └─────────────┘         └─────────────┘

4. 构建部署
   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
   │   Gitea     │ ──────▶ │  Jenkins    │ ──────▶ │   K8s       │
   │  Webhook    │         │  Pipeline   │         │  Deployment │
   └─────────────┘         └─────────────┘         └─────────────┘
```

---

## 3. 发布流程

### 3.1 完整发布流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        发布流程时序图                                        │
└─────────────────────────────────────────────────────────────────────────────┘

 设计器        发布服务       版本管理       代码生成器      Gitea       Jenkins
   │             │             │             │             │             │
   │  发布请求   │             │             │             │             │
   │────────────▶│             │             │             │             │
   │             │             │             │             │             │
   │             │ ① 创建版本  │             │             │             │
   │             │────────────▶│             │             │             │
   │             │             │             │             │             │
   │             │  版本号     │             │             │             │
   │             │◀────────────│             │             │             │
   │             │             │             │             │             │
   │             │ ② 生成代码  │             │             │             │
   │             │────────────────────────▶│             │             │
   │             │             │             │             │             │
   │             │             │    源代码   │             │             │
   │             │◀────────────────────────│             │             │
   │             │             │             │             │             │
   │             │ ③ 推送代码  │             │             │             │
   │             │────────────────────────────────────────▶│             │
   │             │             │             │             │             │
   │             │ ④ 触发构建  │             │             │             │
   │             │────────────────────────────────────────────────────▶│
   │             │             │             │             │             │
   │  发布中...  │             │             │             │             │
   │◀────────────│             │             │             │             │
   │             │             │             │             │             │
   │             │             │             │    ⑤ 构建完成 Webhook     │
   │             │◀────────────────────────────────────────────────────│
   │             │             │             │             │             │
   │             │ ⑥ 更新状态  │             │             │             │
   │             │────────────▶│             │             │             │
   │             │             │             │             │             │
   │  发布成功   │             │             │             │             │
   │◀────────────│             │             │             │             │
   │             │             │             │             │             │
```

### 3.2 发布状态流转

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        发布状态机                                            │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │   PENDING   │  待发布
                    │   (草稿)    │
                    └──────┬──────┘
                           │ 点击发布
                           ▼
                    ┌─────────────┐
                    │ GENERATING  │  代码生成中
                    │             │
                    └──────┬──────┘
                           │ 生成完成
                           ▼
                    ┌─────────────┐
                    │  BUILDING   │  构建中
                    │             │
                    └──────┬──────┘
                           │
              ┌────────────┼────────────┐
              │ 构建成功   │            │ 构建失败
              ▼            │            ▼
       ┌─────────────┐     │     ┌─────────────┐
       │  DEPLOYING  │     │     │   FAILED    │
       │  部署中     │     │     │   失败      │
       └──────┬──────┘     │     └──────┬──────┘
              │ 部署成功   │            │
              ▼            │            │ 重试
       ┌─────────────┐     │            │
       │  DEPLOYED   │     │     ┌──────┴──────┐
       │  已部署     │     │     │   重新发布   │
       └──────┬──────┘     │     └─────────────┘
              │            │
              │ 新版本发布 │
              └────────────┘
```

### 3.3 发布 API 设计

```typescript
/**
 * 发布请求
 */
interface PublishRequest {
  // 产品ID
  productId: string;

  // 版本号（可选，默认自动生成）
  versionCode?: string;

  // 发布描述
  description?: string;

  // 发布选项
  options?: PublishOptions;
}

interface PublishOptions {
  // 是否跳过测试
  skipTests?: boolean;

  // 目标环境
  targetEnv: 'staging' | 'production';

  // 是否自动部署
  autoDeploy?: boolean;
}

/**
 * 发布响应
 */
interface PublishResponse {
  // 发布任务ID
  jobId: string;

  // 版本号
  versionCode: string;

  // 当前状态
  status: PublishStatus;

  // 状态查询地址
  statusUrl: string;

  // 预计完成时间
  estimatedTime?: number;
}

/**
 * 发布状态
 */
type PublishStatus =
  | 'pending'      // 待处理
  | 'generating'   // 代码生成中
  | 'building'     // 构建中
  | 'deploying'    // 部署中
  | 'deployed'     // 已部署
  | 'failed';      // 失败

/**
 * 发布状态详情
 */
interface PublishStatusDetail {
  jobId: string;
  status: PublishStatus;
  progress: number;  // 0-100
  currentStep: string;
  steps: PublishStep[];
  logs?: string[];
  error?: PublishError;
}

interface PublishStep {
  name: string;
  status: 'pending' | 'running' | 'completed' | 'failed';
  startTime?: Date;
  endTime?: Date;
  message?: string;
}
```

---

## 4. 产品与版本管理

### 4.1 产品层级结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        产品层级结构                                          │
└─────────────────────────────────────────────────────────────────────────────┘

产品 (Product)
│
├── 基本信息
│   ├── productCode: 产品代码（唯一）
│   ├── productName: 产品名称
│   └── description: 产品描述
│
├── 模块列表
│   ├── Module A (订单模块)
│   │   ├── V1 版本
│   │   └── V2 版本
│   ├── Module B (商品模块)
│   │   └── V1 版本
│   └── Module C (用户模块)
│       └── V1 版本
│
├── 发布版本
│   ├── v1.0.0 (已发布)
│   │   ├── 包含模块: A-V1, B-V1, C-V1
│   │   └── 发布时间: 2025-01-01
│   ├── v1.1.0 (已发布)
│   │   ├── 包含模块: A-V2, B-V1, C-V1
│   │   └── 发布时间: 2025-01-15
│   └── v1.2.0 (开发中)
│       └── 包含模块: A-V2, B-V1, C-V1
│
└── 部署状态
    ├── staging: v1.1.0
    └── production: v1.0.0
```

### 4.2 产品表设计

```sql
-- 产品表
CREATE TABLE ab_product (
    id              BIGINT NOT NULL COMMENT '主键',

    -- 产品标识
    product_code    VARCHAR(100) NOT NULL COMMENT '产品代码',
    product_name    VARCHAR(200) NOT NULL COMMENT '产品名称',
    description     VARCHAR(500) COMMENT '产品描述',

    -- Git 仓库信息
    git_repo_url    VARCHAR(500) COMMENT 'Git 仓库地址',
    git_repo_id     BIGINT COMMENT 'Gitea 仓库ID',

    -- 当前发布版本
    current_version VARCHAR(50) COMMENT '当前发布版本号',
    current_version_id BIGINT COMMENT '当前发布版本ID',

    -- 审计字段
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    creator_id      BIGINT,
    creator_name    VARCHAR(50),
    modifier_at     DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    modifier_id     BIGINT,
    modifier_name   VARCHAR(50),
    is_removed      TINYINT(1) DEFAULT 0,
    version         BIGINT DEFAULT 0,
    sort_code       INT,
    is_enable       TINYINT(1) DEFAULT 1,

    PRIMARY KEY (id)
) COMMENT '产品表';

-- 产品模块关联表
CREATE TABLE ab_product_module (
    id              BIGINT NOT NULL COMMENT '主键',

    -- 关联
    product_id      BIGINT NOT NULL COMMENT '产品ID',
    module_id       BIGINT NOT NULL COMMENT '模块ID',

    -- 冗余
    product_code    VARCHAR(100) NOT NULL COMMENT '产品代码',
    module_code     VARCHAR(100) NOT NULL COMMENT '模块代码',

    -- 使用的模块版本
    module_version_id   BIGINT COMMENT '使用的模块版本ID',
    module_version_code VARCHAR(20) COMMENT '使用的模块版本号',

    -- 审计字段
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_removed      TINYINT(1) DEFAULT 0,

    PRIMARY KEY (id)
) COMMENT '产品模块关联表';

-- 产品发布版本表
CREATE TABLE ab_product_release (
    id              BIGINT NOT NULL COMMENT '主键',

    -- 关联产品
    product_id      BIGINT NOT NULL COMMENT '产品ID',
    product_code    VARCHAR(100) NOT NULL COMMENT '产品代码',

    -- 版本信息
    version_code    VARCHAR(50) NOT NULL COMMENT '版本号 (语义化版本)',
    version_name    VARCHAR(200) COMMENT '版本名称',
    description     TEXT COMMENT '版本说明/变更日志',

    -- 发布状态
    status          VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT '状态',
    published_at    DATETIME COMMENT '发布时间',

    -- 模块快照 (JSON)
    module_snapshot JSON COMMENT '发布时的模块版本快照',

    -- Git 信息
    git_branch      VARCHAR(100) COMMENT 'Git 分支',
    git_commit_id   VARCHAR(64) COMMENT 'Git commit ID',
    git_tag         VARCHAR(100) COMMENT 'Git tag',

    -- 构建信息
    build_job_id    VARCHAR(100) COMMENT '构建任务ID',
    docker_image    VARCHAR(500) COMMENT 'Docker 镜像地址',
    build_log_url   VARCHAR(500) COMMENT '构建日志地址',

    -- 审计字段
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    creator_id      BIGINT,
    creator_name    VARCHAR(50),
    modifier_at     DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_removed      TINYINT(1) DEFAULT 0,

    PRIMARY KEY (id)
) COMMENT '产品发布版本表';
```

### 4.3 版本号规范

采用语义化版本 (Semantic Versioning)：

```
MAJOR.MINOR.PATCH[-PRERELEASE]

示例：
- 1.0.0        正式版
- 1.0.1        补丁版本（bug 修复）
- 1.1.0        次版本（新功能，向下兼容）
- 2.0.0        主版本（重大变更，不兼容）
- 1.2.0-beta.1 预发布版本
```

**自动版本号生成规则：**

```typescript
function generateNextVersion(
  currentVersion: string,
  changeType: 'major' | 'minor' | 'patch'
): string {
  const [major, minor, patch] = currentVersion.split('.').map(Number);

  switch (changeType) {
    case 'major':
      return `${major + 1}.0.0`;
    case 'minor':
      return `${major}.${minor + 1}.0`;
    case 'patch':
      return `${major}.${minor}.${patch + 1}`;
  }
}
```

---

## 5. 环境策略

### 5.1 环境分层

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        环境分层策略                                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         开发/预览环境 (Preview)                              │
│                                                                             │
│   特点：                                                                    │
│   - 使用运行时引擎（解释执行）                                                │
│   - 配置修改秒级生效                                                         │
│   - 用于设计器实时预览                                                       │
│   - 性能较低，但迭代快                                                       │
│                                                                             │
│   ┌─────────────┐                    ┌─────────────┐                       │
│   │   设计器     │ ───── 保存 ─────▶ │  预览页面    │                       │
│   └─────────────┘                    │ (运行时渲染) │                       │
│         │                            └─────────────┘                       │
│         │ 修改配置                           ↑                              │
│         ▼                                   │                              │
│   ┌─────────────┐                           │                              │
│   │  OSS 草稿   │ ─────────────────────────┘                              │
│   └─────────────┘                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 发布
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          预发布环境 (Staging)                                │
│                                                                             │
│   特点：                                                                    │
│   - 使用生成代码（编译执行）                                                  │
│   - 与生产环境架构一致                                                       │
│   - 用于集成测试和验收                                                       │
│   - 数据与生产隔离                                                          │
│                                                                             │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                  │
│   │  生成代码   │ ──▶ │  构建镜像   │ ──▶ │  Staging    │                  │
│   │            │     │            │     │  K8s 集群   │                  │
│   └─────────────┘     └─────────────┘     └─────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 审批 & 发布
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          生产环境 (Production)                               │
│                                                                             │
│   特点：                                                                    │
│   - 使用生成代码（编译执行）                                                  │
│   - 高可用部署                                                              │
│   - 性能监控和告警                                                          │
│   - 支持灰度发布                                                            │
│                                                                             │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                  │
│   │  同一镜像   │ ──▶ │  灰度发布   │ ──▶ │ Production  │                  │
│   │            │     │   策略     │     │  K8s 集群   │                  │
│   └─────────────┘     └─────────────┘     └─────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 预览环境与生产环境对比

| 特性 | 预览环境 | 生产环境 |
|-----|---------|---------|
| **执行方式** | 运行时解释 | 编译执行 |
| **生效时间** | 秒级 | 分钟级（需构建） |
| **性能** | 较低 | 最优 |
| **用途** | 设计器预览 | 正式对外服务 |
| **稳定性** | 一般 | 高 |
| **可调试** | 有限 | 完整 |

### 5.3 灰度发布策略

```yaml
# 灰度发布配置示例
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: product-service
spec:
  hosts:
    - product-service
  http:
    - match:
        - headers:
            x-canary:
              exact: "true"
      route:
        - destination:
            host: product-service
            subset: canary
          weight: 100
    - route:
        - destination:
            host: product-service
            subset: stable
          weight: 90
        - destination:
            host: product-service
            subset: canary
          weight: 10
```

---

## 6. 回滚机制

### 6.1 回滚策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        回滚机制                                              │
└─────────────────────────────────────────────────────────────────────────────┘

方式一：快速回滚（推荐）
┌─────────────┐                              ┌─────────────┐
│ 当前版本    │       K8s Rollout            │ 上一版本    │
│ v1.2.0     │  ─────────────────────────▶  │ v1.1.0     │
│ (问题版本) │     直接切换镜像版本           │ (稳定版本) │
└─────────────┘                              └─────────────┘
优点：秒级完成，无需重新构建
适用：紧急回滚场景

方式二：重新发布
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 选择历史版本 │ ──▶ │ 重新生成代码 │ ──▶ │  重新构建   │ ──▶ │   部署     │
│ v1.1.0     │     │            │     │            │     │            │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
优点：可以选择任意历史版本
适用：需要回滚到较早版本
```

### 6.2 回滚 API

```typescript
/**
 * 回滚请求
 */
interface RollbackRequest {
  // 产品ID
  productId: string;

  // 目标版本
  targetVersion: string;

  // 回滚方式
  strategy: 'quick' | 'rebuild';

  // 目标环境
  targetEnv: 'staging' | 'production';

  // 回滚原因
  reason: string;
}

/**
 * 回滚响应
 */
interface RollbackResponse {
  // 回滚任务ID
  jobId: string;

  // 原版本
  fromVersion: string;

  // 目标版本
  toVersion: string;

  // 状态
  status: 'pending' | 'rolling' | 'completed' | 'failed';
}
```

### 6.3 版本保留策略

```typescript
/**
 * 版本保留策略
 */
interface RetentionPolicy {
  // 保留的发布版本数量
  maxReleaseVersions: number;  // 默认 20

  // 保留的 Docker 镜像数量
  maxDockerImages: number;     // 默认 10

  // 保留的 Git 分支数量
  maxGitBranches: number;      // 默认 10

  // 最小保留天数
  minRetentionDays: number;    // 默认 30
}
```

---

## 7. 设计决策记录与相关文档

### 7.1 设计决策记录

| 问题 | 决策 | 说明 |
|-----|------|------|
| 执行模式 | 代码生成 + 构建发布 | 性能最优，可维护性好，AI 友好 |
| 部署粒度 | 产品级服务 | 同一产品的所有模块打包为一个服务 |
| 代码可编辑性 | 纯生成，禁止修改 | 简化流程，所有定制通过配置实现 |
| 前端策略 | 前端也生成代码 | 前后端统一发布流程 |
| 预览方式 | 运行时引擎 | 设计器预览秒级生效 |
| 版本管理 | 语义化版本 | 标准规范，易于理解 |
| 回滚机制 | 快速回滚 + 重新发布 | 兼顾速度和灵活性 |

### 7.2 相关文档

| 序号 | 文档 | 状态 | 主要内容 |
|:---:|-----|:----:|---------|
| 1 | [代码生成设计](./code-generation.md) | 📝 | 生成器架构、模板引擎、生成规则 |
| 2 | [构建流程设计](./build-process.md) | 📝 | CI/CD 流水线、镜像构建、质量门禁 |
| 3 | [部署方案设计](./deployment.md) | 📝 | K8s 部署、灰度发布、监控告警 |

> 图例: ✅ 已完成 | 📝 待编写

---
