# Assembox 低代码平台架构设计文档

> **版本**: v3.0
> **更新日期**: 2025-01-24
> **设计目标**: 构建以模型为核心、元数据驱动的全栈低代码企业级SaaS开发平台
> **架构特点**: 代码生成 + 构建发布模式（非运行时解释）

---

## 文档说明

本文档采用**模块化设计**方式，所有设计文档统一存放在 `docs/design/` 目录下。

**文档结构：**

设计文档按照五个核心方向组织：

```
docs/design/
├── outline.md                    # 本文档（总体架构设计大纲）
│
├── 01-storage/                   # 一、存储层设计
│   ├── overview.md               # 存储层总览
│   ├── config-detail.md          # 配置详细结构设计
│   ├── component-types.md        # 组件类型定义
│   ├── version-management.md     # 版本管理设计
│   ├── cache-strategy.md         # 缓存策略设计
│   └── oss-operations.md         # OSS操作设计
│
├── 02-service/                   # 二、服务层设计
│   ├── overview.md               # 服务层总览
│   ├── config-service.md         # 配置服务设计
│   ├── meta-service.md           # 元数据服务设计
│   ├── runtime-service.md        # 运行时服务设计
│   └── plugin-service.md         # 插件服务设计
│
├── 03-frontend/                  # 三、前端层设计
│   ├── overview.md               # 前端层总览
│   ├── runtime.md                # 核心运行时设计
│   ├── pc-renderer.md            # PC端渲染器设计
│   ├── mobile-renderer.md        # 移动端渲染器设计
│   └── components.md             # 组件库设计
│
├── 04-designer/                  # 四、设计器工具设计
│   ├── overview.md               # 设计器总览
│   ├── drag-drop.md              # 拖拽系统设计
│   ├── canvas.md                 # 画布渲染设计
│   ├── property-panel.md         # 属性面板设计
│   └── preview.md                # 预览系统设计
│
└── 05-publish/                   # 五、发布流程设计
    ├── overview.md               # 发布流程总览
    ├── build-process.md          # 构建流程设计
    ├── code-generation.md        # 代码生成设计
    └── deployment.md             # 部署方案设计
```

**设计阶段：**
1. **总体框架设计**（当前）- 确定整体架构、模块划分
2. **模块详细设计** - 逐模块完成详细设计
3. **实施阶段** - 编码实现、测试验证

**文档状态：**
- 🟢 已完成
- 🟡 进行中
- 🔴 待设计

| 设计方向 | 状态 | 说明 |
|---------|------|------|
| 一、存储层设计 | 🟢 | 配置存储、版本管理、缓存策略 |
| 二、服务层设计 | 🟢 | 配置服务、元数据服务、预览引擎、发布模块 |
| 三、前端层设计 | 🟢 | 运行时、渲染器、组件库 |
| 四、设计器工具设计 | 🔴 | 拖拽、画布、属性面板、预览 |
| 五、发布流程设计 | 🟢 | **代码生成**、构建流程、部署方案 |

---

## 目录

### 第一部分：总体设计
- [1. 项目概述](#1-项目概述)
- [2. 架构原则](#2-架构原则)
- [3. 总体架构设计](#3-总体架构设计)
- [4. 核心概念](#4-核心概念)
- [5. 技术选型](#5-技术选型)
- [6. 部署架构](#6-部署架构)
- [7. 现有代码复用计划](#7-现有代码复用计划)
- [8. 实施路线图](#8-实施路线图)

### 第二部分：五大设计方向详细索引
- [一、存储层设计](#一存储层设计) → [01-storage/](./01-storage/)
- [二、服务层设计](#二服务层设计) → [02-service/](./02-service/)
- [三、前端层设计](#三前端层设计) → [03-frontend/](./03-frontend/)
- [四、设计器工具设计](#四设计器工具设计) → [04-designer/](./04-designer/)
- [五、发布流程设计](#五发布流程设计) → [05-publish/](./05-publish/)

---

# 第一部分：总体设计

---

## 1. 项目概述

### 1.1 项目定位

Assembox 是一个企业级 SaaS 低代码开发平台，面向业务人员和开发人员，通过可视化配置快速构建企业应用。

**核心特征：**
- **以模型为核心**：一切皆模型，页面、组件、API 都由模型定义
- **元数据驱动**：通过 JSON 配置驱动整个应用运行
- **全栈能力**：覆盖前端渲染、后端服务、数据存储的完整链路
- **多端支持**：一次配置，同时生成 PC 端和移动端应用

### 1.2 目标用户

| 用户角色 | 使用场景 | 核心诉求 |
|---------|---------|---------|
| 业务人员 | 快速搭建业务页面 | 无代码/低代码，可视化操作 |
| 开发人员 | 扩展组件、开发复杂功能 | 代码可扩展性、调试便利性 |
| 运维人员 | 部署、监控应用 | 部署简单、运行稳定 |

### 1.3 与现有代码的关系

本项目基于 `packages` 目录下的现有实现进行重构升级：

| 现有包 | 作用 | 新版本复用策略 |
|-------|------|--------------|
| assembox-core | 前端请求工具、数据模型管理 | **复用核心逻辑，重构架构** |
| assembox-desktop | PC端UI渲染库 | **复用组件，重构渲染机制** |
| assembox-mobile | 移动端UI渲染库 | **复用组件，重构渲染机制** |
| assembox-editor | 低代码设计器 | **复用设计思路，重构架构** |
| aseembox-service | 后端服务Demo | **参考实现，重新设计** |

---

## 2. 架构原则

### 2.1 核心设计原则

1. **模型驱动 (Model-Driven)**
   - 页面结构、组件属性、事件处理都由模型定义
   - 模型是唯一的真实数据源 (Single Source of Truth)

2. **元数据驱动 (Metadata-Driven)**
   - 运行时行为由元数据配置决定
   - 无需修改代码即可改变应用行为

3. **分层解耦 (Layered Decoupling)**
   - 各层之间通过明确的接口通信
   - 上层不依赖下层的具体实现

4. **基于云阙平台基础设施实现 (Platform Agnostic)**
   - 核心逻辑基于云阙平台基础设施
   - 支持PC、移动端、小程序等多端渲染

5. **可扩展性 (Extensibility)**
   - 支持自定义组件
   - 支持自定义服务逻辑
   - 支持插件化扩展

### 2.2 技术原则

- **类型安全**: 全面使用 TypeScript
- **响应式**: 基于 Vue 3 响应式系统
- **模块化**: Monorepo 管理，模块独立发布
- **测试驱动**: 核心模块有完整的单元测试

---

## 3. 总体架构设计

### 3.1 分层架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         低代码设计器                                 │
│                    (assembox-designer)                              │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          前端渲染层                                   │
├─────────────────┬─────────────────┬─────────────────┬───────────────┤
│  API调用管理     │  PC端UI渲染器   │  移动端UI渲染器 │  组件库       │
│ (assembox-api)  │(assembox-pc)   │(assembox-mobile)│ (components)  │
├─────────────────┴─────────────────┴─────────────────┴───────────────┤
│                        核心运行时                                     │
│                      (assembox-runtime)                              │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────────────┐
│                          动态服务层                                   │
├─────────────────┬─────────────────┬─────────────────┬───────────────┤
│   模型管理       │   服务渲染器     │   API渲染器      │  权限控制     │
│ (model-service) │ (service-render)│ (api-renderer)  │ (auth-guard)  │
├─────────────────┴─────────────────┴─────────────────┴───────────────┤
│                       服务运行时                                      │
│                    (assembox-server)                                 │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        配置存储层                                     │
├─────────────────┬─────────────────┬─────────────────┬───────────────┤
│   配置存储       │   配置缓存       │   版本管理       │  Git集成      │
│ (MongoDB)       │   (Redis)       │  (VersionMgr)   │  (Gitea)      │
└─────────────────┴─────────────────┴─────────────────┴───────────────┘
```

### 3.2 模块依赖关系

```
assembox-designer
    │
    ├──> assembox-pc (PC渲染器)
    │         │
    │         └──> assembox-runtime (核心运行时)
    │                   │
    │                   └──> assembox-api (API调用)
    │
    ├──> assembox-mobile (移动端渲染器)
    │         │
    │         └──> assembox-runtime (核心运行时)
    │
    └──> assembox-server (服务端)
              │
              ├──> model-service (模型管理)
              ├──> service-renderer (服务渲染)
              └──> config-store (配置存储)
                        │
                        └──> Git Integration (Gitea)
```

### 3.3 Monorepo 包结构规划

```
packages/
├── assembox-runtime/          # 核心运行时（NEW）
├── assembox-api/              # API调用管理（从core分离）
├── assembox-pc/               # PC端渲染器（重构assembox-desktop）
├── assembox-mobile/           # 移动端渲染器（重构assembox-mobile）
├── assembox-components/       # 通用组件库（NEW）
├── assembox-designer/         # 低代码设计器（重构assembox-editor）
├── assembox-server/           # 服务端（重构aseembox-service）
├── assembox-store/            # 配置存储（NEW）
├── assembox-builder/          # 发布构建工具（NEW）
├── assembox-git/              # Git集成服务（NEW）
└── assembox-types/            # 类型定义（NEW）
```

---

## 4. 核心概念

### 4.1 模型 (Model)

模型是系统的核心概念，描述应用的结构和行为。

| 模型类型 | 说明 | 示例 |
|---------|------|------|
| 页面模型 | 描述页面结构和组件树 | 首页、列表页、详情页 |
| 组件模型 | 描述组件的属性和事件 | Input、Table、Form |
| 数据模型 | 描述数据结构和校验规则 | 用户、订单、商品 |
| API模型 | 描述接口定义和参数 | 查询列表、保存数据 |
| 应用模型 | 描述应用整体配置 | 路由、主题、权限 |

### 4.2 元数据 (Metadata)

元数据是描述模型的数据，以 JSON 格式存储。

```typescript
// 页面元数据示例
interface PageMetadata {
  id: string;
  name: string;
  route: string;
  layout: ComponentMetadata;
  dataSource: DataSourceMetadata;
  permissions: string[];
}
```

### 4.3 渲染器 (Renderer)

渲染器负责将元数据转换为实际的 UI。

| 渲染器 | 职责 |
|-------|------|
| ComponentRenderer | 组件渲染，处理 props、事件 |
| ContainerRenderer | 容器渲染，处理布局、嵌套 |
| ListRenderer | 列表渲染，处理循环、条件 |

### 4.4 服务渲染 (Service Rendering)

服务端根据模型定义动态生成 API。

```
模型定义 → SQL构建 → 参数验证 → 执行查询 → 结果封装 → 响应
```

---

## 5. 技术选型

### 5.1 前端技术栈

| 技术 | 版本 | 用途 | 说明 |
|-----|------|-----|------|
| Vue | 3.4+ | 核心框架 | 响应式系统 |
| TypeScript | 5.0+ | 类型系统 | 类型安全 |
| Vite | 5.0+ | 构建工具 | 快速开发 |
| Element Plus | latest | PC组件库 | PC端UI基础 |
| NutUI | latest | 移动组件库 | 移动端UI基础 |

### 5.2 后端技术栈

| 技术 | 版本 | 用途 | 说明 |
|-----|------|-----|------|
| Node.js | 20+ | 运行时 | LTS版本 |
| NestJS | 10+ | 服务框架 | 模块化架构 |
| TIDB | 8.0+ | 文档数据库 | 元数据存储 |
| Redis | 7.0+ | 缓存 | 配置缓存 |
| Gitea | latest | 代码仓库 | 版本管理 |

### 5.3 开发工具

| 工具 | 用途 |
|-----|------|
| pnpm | 包管理器（Monorepo） |
| Turbo | 构建系统 |
| Vitest | 单元测试 |
| ESLint + Prettier | 代码规范 |

---

## 6. 部署架构

```
┌───────────────────────────────────────────────────────┐
│                     负载均衡                          │
│                   (Nginx/SLB)                         │
└───────────────────────────────────────────────────────┘
                           │
         ┌─────────────────┼─────────────────┐
         ▼                 ▼                 ▼
┌────────────────┐ ┌────────────────┐ ┌────────────────┐
│  设计器服务    │ │  应用服务      │ │  API服务       │
│  (Node.js)     │ │  (Node.js)     │ │  (Node.js)     │
└────────────────┘ └────────────────┘ └────────────────┘
         │                 │                 │
         └─────────────────┼─────────────────┘
                           ▼
                  ┌────────────────┐
                  │   TIDB         │
                  │   (副本集)      │
                  └────────────────┘
                           │
                  ┌────────────────┐
                  │    Redis       │
                  │   (集群)        │
                  └────────────────┘
                           │
                  ┌────────────────┐
                  │    Gitea       │
                  │  (版本管理)     │
                  └────────────────┘
```

---

## 7. 现有代码复用计划

### 7.1 可复用的资产

| 资产 | 来源 | 复用方式 |
|-----|------|---------|
| 数据模型类型定义 | assembox-core | 直接复用，补充完善 |
| 事件系统 | assembox-core | 重构后复用 |
| API 调用逻辑 | assembox-core | 重构后复用 |
| PC 组件库 | assembox-desktop | 直接复用 |
| 移动组件库 | assembox-mobile | 直接复用 |
| 设计器拖拽系统 | assembox-editor | 重构后复用 |
| 服务端 SQL 构建器 | aseembox-service | 参考实现 |

### 7.2 需要重构的部分

| 模块 | 重构原因 |
|-----|---------|
| assembox-core | 职责过多，需要拆分 |
| 渲染器 | 组件耦合度高，需要解耦 |
| 设计器 | 架构不清晰，需要重新设计 |
| 服务端 | Demo 性质，需要生产级改造 |

---

## 8. 实施路线图

### 8.1 阶段划分

```
阶段1: 基础框架搭建
├── Monorepo 结构建立
├── 构建系统配置
├── 类型定义模块
└── 核心运行时框架

阶段2: 配置存储层
├── MongoDB Schema 设计
├── 配置存储服务
├── Git 集成服务
└── 缓存服务

阶段3: 动态服务层
├── 模型元数据服务
├── 动态 API 生成
├── 权限控制
└── 数据验证

阶段4: 前端渲染层
├── 核心运行时
├── PC 渲染器
├── 移动渲染器
└── 组件库整理

阶段5: 低代码设计器
├── 设计器框架
├── 拖拽系统
├── 属性配置面板
└── 预览功能

阶段6: 发布构建工具
├── 构建配置
├── 代码生成
└── 部署工具
```

### 8.2 里程碑

| 里程碑 | 目标 | 交付物 |
|-------|------|-------|
| M1 | 基础框架完成 | 可运行的开发环境 |
| M2 | 存储层完成 | 元数据 CRUD 可用 |
| M3 | 服务层完成 | 动态 API 可用 |
| M4 | 渲染层完成 | 页面可渲染 |
| M5 | 设计器完成 | 可视化配置可用 |
| M6 | 构建工具完成 | 可发布应用 |

---

# 第二部分：五大设计方向详细索引

---

## 一、存储层设计

**状态**: 🟢 已完成

**目录**: [01-storage/](./01-storage/)

**职责**：
- 所有元数据的存储、查询、缓存
- 版本管理和历史追踪
- 多租户隔离
- 并发编辑控制

**核心功能**：
- 配置存储与管理
- 组件类型定义和扩展
- 版本管理和回滚
- 缓存策略优化
- OSS 文件操作

**文档索引**：
| 文档 | 说明 |
|-----|------|
| [overview.md](./01-storage/overview.md) | 存储层总览和架构设计 |
| [config-detail.md](./01-storage/config-detail.md) | 配置详细结构设计 |
| [component-types.md](./01-storage/component-types.md) | 组件类型分类和扩展机制 |
| [version-management.md](./01-storage/version-management.md) | 版本管理设计 |
| [cache-strategy.md](./01-storage/cache-strategy.md) | 缓存策略设计 |
| [oss-operations.md](./01-storage/oss-operations.md) | OSS 操作设计 |

---

## 二、服务层设计

**状态**: 🟢 已完成

**目录**: [02-service/](./02-service/)

**架构说明**：
> 服务层在新架构下分为两种执行模式：
> - **预览模式**：设计器实时预览，使用运行时解释执行（秒级生效）
> - **生产模式**：发布后使用生成代码执行（性能最优）

**职责**：
- 元数据管理（模型、字段、关联）
- 配置管理（页面配置、版本控制）
- **预览引擎**（设计时实时预览）
- **发布编排**（代码生成、CI/CD 触发）
- 插件系统（编译时插桩）

**核心模块**：
| 模块 | 职责 | 使用场景 |
|-----|------|---------|
| MetaModule | 元数据管理 | 设计时 |
| ConfigModule | 配置 CRUD、版本管理 | 设计时 |
| PreviewModule | 预览引擎（运行时解释）| 设计时 |
| **PublishModule** | 代码生成、构建编排 | **发布时** |
| PluginModule | 编译时插桩 | 发布时 |

**文档索引**：
| 文档 | 说明 |
|-----|------|
| [overview.md](./02-service/overview.md) | 服务层总览：架构转型、模块设计 |
| [config-service.md](./02-service/config-service.md) | 配置服务设计 |
| [meta-service.md](./02-service/meta-service.md) | 元数据服务设计 |
| [runtime-service.md](./02-service/runtime-service.md) | 预览服务设计（原运行时服务，已降级） |
| [plugin-service.md](./02-service/plugin-service.md) | 插件服务设计（编译时插桩） |

---

## 三、前端层设计

**状态**: 🟢 已完成

**目录**: [03-frontend/](./03-frontend/)

**职责**：
- 页面渲染和用户交互
- 组件动态加载
- 数据双向绑定
- 事件处理
- 路由管理

**核心功能**：
- 核心运行时引擎
- PC 端渲染器
- 移动端渲染器
- 统一组件库

**文档索引**：
| 文档 | 说明 |
|-----|------|
| [overview.md](./03-frontend/overview.md) | 前端层总览和架构设计 |
| [runtime.md](./03-frontend/runtime.md) | 核心运行时设计 |
| [pc-renderer.md](./03-frontend/pc-renderer.md) | PC 端渲染器设计 |
| [mobile-renderer.md](./03-frontend/mobile-renderer.md) | 移动端渲染器设计 |
| [components.md](./03-frontend/components.md) | 组件库设计 |

---

## 四、设计器工具设计

**状态**: 🔴 待设计

**目录**: [04-designer/](./04-designer/)

**职责**：
- 可视化配置页面和组件
- 实时预览
- Schema 导出
- 用户交互体验

**核心功能**：
- 拖拽系统
- 画布渲染
- 属性配置面板
- 预览系统
- 撤销/重做

**文档索引**：
| 文档 | 说明 |
|-----|------|
| [overview.md](./04-designer/overview.md) | 设计器总览和架构设计 |
| [drag-drop.md](./04-designer/drag-drop.md) | 拖拽系统设计 |
| [canvas.md](./04-designer/canvas.md) | 画布渲染设计 |
| [property-panel.md](./04-designer/property-panel.md) | 属性面板设计 |
| [preview.md](./04-designer/preview.md) | 预览系统设计 |

---

## 五、发布流程设计

**状态**: 🟢 已完成

**目录**: [05-publish/](./05-publish/)

**架构核心**：
> Assembox 采用 **"代码生成 + 构建发布"** 模式，而非传统低代码平台的"运行时解释"模式。
> 元数据配置在发布时被编译为标准的 NestJS 后端代码和 Vue 3 前端代码，获得最优性能和可调试性。

**职责**：
- 将元数据配置编译为标准源代码（NestJS + Vue 3）
- 代码生成（Entity、DTO、Controller、Service、Vue组件）
- CI/CD 构建流水线
- K8s 部署与灰度发布

**核心功能**：
- **代码生成器**：ts-morph 生成 TypeScript，EJS 生成 Vue SFC
- **构建流程**：Jenkins Pipeline，Docker 镜像构建
- **部署方案**：K8s 编排，Istio 灰度发布
- **版本管理**：产品级发布，语义化版本

**设计决策**：
| 决策点 | 选择 | 原因 |
|-------|------|------|
| 执行模式 | 代码生成（非运行时解释） | 性能最优，可调试，AI友好 |
| 部署粒度 | 产品级服务 | 同一产品所有模块打包为一个服务 |
| 代码可编辑性 | 纯生成，禁止修改 | 元数据是唯一真实来源 |
| 前端策略 | 前端也生成代码 | 前后端统一发布流程 |

**文档索引**：
| 文档 | 说明 |
|-----|------|
| [overview.md](./05-publish/overview.md) | 发布流程总览：架构对比、发布流程、版本管理 |
| [code-generation.md](./05-publish/code-generation.md) | **代码生成设计（核心）**：生成器架构、后端/前端代码生成 |
| [build-process.md](./05-publish/build-process.md) | 构建流程设计：CI/CD 流水线、质量门禁、镜像构建 |
| [deployment.md](./05-publish/deployment.md) | 部署方案设计：K8s 资源、发布策略、监控告警 |

---

## 附录

### A. 术语表

| 术语 | 说明 |
|-----|------|
| 模型 | 描述应用结构和行为的抽象概念 |
| 元数据 | 描述模型的数据，JSON 格式 |
| 渲染器 | 将元数据转换为 UI 的组件 |
| 服务渲染 | 根据模型动态生成 API |
| 骨架 | 页面的结构描述 |
| 组件树 | 页面的组件层级结构 |

### B. 参考资料

- 现有代码库: `packages/` 目录
- 类型定义: `packages/assembox-core/src/type/`
- 设计器实现: `packages/assembox-editor/`
- 后端服务: `packages/aseembox-service/`

---

